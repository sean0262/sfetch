#!/bin/env bash
kernel=$(uname -r)
shell=$(echo `$SHELL --version` | cut -d'(' -f1)
uptime=$(uptime -p)
vn=$(echo "0.0.8a")

declare -A osInf;
osInf[/etc/redhat-release]=yum
osInf[/etc/arch-release]=pacman
osInf[/etc/gentoo-release]=emerge
osInf[/etc/SuSE-release]=zypp
osInf[/etc/debian_release]=apt-get
osInf[/etc/ubuntu-release]=apt-get
osInf[/etc/debian_version]=apt-get
# Change to 'slackpkg' to '/usr/sbin/slackpkg' if not working!
osInf[/etc/slackware-version]=slackpkg


# Arguments . . .
if [ "$1" == "--PM" ] || [ "$1" == "--pm" ] || [ "$1" == "--Package-Manager" ]; then
	for f in ${!osInf[@]}
	do
		if [[ -f $f ]];then
			echo "$(${osInf[$f]})"
		fi
	done
elif [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
	echo "Available Arguments:"
	echo "Package Manager [--PM]	Displays Package Manager"
	echo "Help [-h][--help]	Displays Available Arguments"
	echo "Version [--version]	Displays Current sfetch Version"
elif [ "$1" == "--version" ]; then
	echo "version $vn"
fi


# Information-check . . .
if [[ $# -eq 0 ]] ; then
	host=$(cat /sys/devices/virtual/dmi/id/product_name /sys/devices/virtual/dmi/id/product_version | tr '\n' ' ')

	if [[ "$OSTYPE" =~ "FreeBSD" ]]; then
		host=$(sysctl -n hw.model)
		distro=$(uname -mrs)
		max_memory=$(($(sysctl -n hw.physmem) / 1024 / 1024))
		memory="${max_memory}M"
		s=$(sysctl -n kern.boottime)
		s=${s#*=}
		s=${s%,*}
		s=$(($(date +%s) - s))
		d=$((s / 60 / 60 / 24))
		h=$((s / 60 / 60 % 24))
		m=$((s / 60 % 60))
		[ "$d" = 0 ] || uptime="${uptime}${d}d "
		[ "$h" = 0 ] || uptime="${uptime}${h}h "
		[ "$m" = 0 ] || uptime="${uptime}${m}m "
		
		log uptime "${time: -0min}" >&6
	elif [[ "$OSTYPE" =~ "linux" ]]; then
		host=$(cat /sys/devices/virtual/dmi/id/product_name /sys/devices/virtual/dmi/product_version | tr '\n' ' ') 
		distro=$(cat /etc/os-release | head -1 | sed 's/" //g' | cut -d= -f2)
		memory=$(free -hm | akw 'NR==2{printf "%s%s\n}')
	fi	

	if [[ $distro =~ "Debian" ]] || [[ $distro =~ "Ubuntu" ]] || [[ $distro =~ "Raspbian" ]]  
	then
  		packages=$(dpkg-query -W | wc -l)
	fi

	if [[ $distro =~ "Raspbian" ]]
	then
		host=$(cat /sys/firmware/devicetree/base/model | echo "\n")
	fi

	if [[ $distro =~ "Slackware" ]] 
	then
  		packages=$(ls /var/log/packages | wc -l)
	fi

	if [ -n "$XDG_CURRENT_DESKTOP" ]; then
		de=$(echo "$XDG_CURRENT_DESKTOP")
	else
  		de=$(echo "None")
	fi

	if [ -n "$GDMSESSION" ]; then
  		session=$(echo "$GDMSESSION")
	else
  		session=$(echo "None")
	fi


	echo "OS: $distro"
	echo "DE: $de"
	echo "Host: $host"
	echo "Kernel: $kernel"
	echo "Shell: $shell"
	echo "Uptime: $uptime"
	# echo "Packages: $packages"
	# echo "Session: $session"
	echo "Memory: $memory"
fi
